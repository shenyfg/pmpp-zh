# 第4章

### 解答 1

#### a

一个warp默认有32个线程，每个块中有128个线程，共 128 / 32 = 4 个warp

#### b

网格中共有8个块，所以一共有 8 * 128 / 32 = 32个warp

#### c

> 发散（divergent）指的是同一个warp里的线程走了不同的分支路径

i. 每个块中有3个warp活跃，所以一共有24个warp活跃
ii. 第1、3个warp是发散的，所以共有 2 \* 8 = 16 个warp是发散的
iii. warp0全部活跃，所以效率是100%
iv. warp1中有8个线程活跃，所以效率是25%
v. warp3中有24个线程活跃，所以效率是75%

#### d

i. 网格中32个warp都是活跃的
ii. 网格中32个warp都是发散的
iii. simd效率是50%

#### e

i. 前3次迭代没有发散
ii. 第4、5次迭代有发散

### 解答2

一共需要4个块，网格内共有 2048 个线程

### 解答3

每个warp有32个线程，则发散的warp有一个，只有线程id在 1984 ~ 2015 的warp会发散

### 解答4

总执行时间：3.0 \* 8 = 24.0，等待时间：4.1，百分比：17.1%

### 解答5

1. 内存一致性问题。如果不同的线程有共享内存，则可能有读写问题
1. 硬件架构的变化问题。未来英伟达的warp可能包含的线程数会变化，所以显示添加`__syncthreads`是更健壮的方式
1. 编译器优化问题。编译器可能会重排指令顺序，导致程序产生非预期的效果。

### 解答6

c

每个块512个线程，共3个线程块

### 解答7

a. 可能，占用率 8 \* 128 / 2048 = 50%

b. 可能，占用率 16 \* 64 / 2048 = 50%

c. 可能，占用率 32 \* 32 / 2048 = 50%

d. 可能，占用率 64 \* 32 / 2048 = 100%

e. 可能，占用率 32 \* 64 / 2048 = 100%

### 解答8

> SM完全占用：所有的线程都参与了计算

a.

跑满SM最少的块数：2048 / 128 = 16 < 32，满足
寄存器限制：65536 / 2048 = 32 > 30，满足

所以可以达到100%完全占用

b.

跑满SM最少的块数：2048 / 32 = 64 > 32，不满足
寄存器限制：65536 / 2048 = 32 > 29，满足

不能达到完全占用，只能跑 32 * 32 = 1024个线程，占用率 50%

c.

跑满SM最少的块数：2048 / 256 = 8 < 32，满足
寄存器限制：65536 / 2048 = 32 < 34，不满足

不能达到完全占用，只能跑 256 * 7 = 1792个线程，占用率87.5%

### 解答9

每个线程计算结果矩阵的一个元素，则需要 1024 \* 1024 = 1048576 个线程。

块总数是 32 \* 32 = 1024，每个块限制线程数是 512，所以这个必然无法实现。
