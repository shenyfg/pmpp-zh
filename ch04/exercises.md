# 第4章

### 练习 1

考虑以下 CUDA 内核及其对应的调用它的主机函数:

```cpp
01 __global__ void foo_kernel(int* a, int* b) {
02     unsigned int i = blockIdx.x*blockDim.x + threadIdx.x;
03     if(threadIdx.x < 40 || threadIdx.x >= 104) {
04         b[i] = a[i] + 1;
05     }
06     if(i%2 == 0) {
07         a[i] = b[i]*2;
08     }
09     for(unsigned int j = 0; j < 5 - (i%3); ++j) {
10         b[i] += j;
11     }
12 }
13 void foo(int* a_d, int* b_d) {
14     unsigned int N = 1024;
15     foo_kernel <<< (N + 128 - 1)/128, 128 >>>(a_d, b_d);
16 }
```

**a. 每个块中有多少个 warp?**

**b. 网格中有多少个 warp?**

**c. 对于第 04 行的语句:**

**i. 网格中有多少个 warp 是活跃的?**

**ii. 网格中有多少个 warp 是发散的?**

**iii. 块 0 的 warp 0 的 SIMD 效率(百分比)是多少?**

**iv. 块 0 的 warp 1 的 SIMD 效率(百分比)是多少?**

**v. 块 0 的 warp 3 的 SIMD 效率(百分比)是多少?**

**d. 对于第 07 行的语句:**

**i. 网格中有多少个 warp 是活跃的?**

**ii. 网格中有多少个 warp 是发散的?**

**iii. 块 0 的 warp 0 的 SIMD 效率(百分比)是多少?**

**e. 对于第 09 行的循环:**

**i. 有多少次迭代没有发散?**

**ii. 有多少次迭代有发散?**

### 练习 2

对于向量加法,假设向量长度为 2000,每个线程计算一个输出元素,线程块大小为 512 个线程。网格中将有多少个线程?

### 练习 3

对于上一个问题,由于向量长度的边界检查,你预期会有多少个 warp 发生发散?

### 练习 4

考虑一个假设的块,其中有 8 个线程在到达屏障之前执行一段代码。这些线程执行该段代码所需的时间(以微秒为单位)如下:2.0、2.3、3.0、2.8、2.4、1.9、2.6 和 2.9;它们将剩余时间用于等待屏障。线程总执行时间中用于等待屏障的时间百分比是多少?

### 练习 5

一位 CUDA 程序员说,如果他们启动一个内核时每个块只有 32 个线程,那么在需要屏障同步的地方可以省略 `__syncthreads()` 指令。你认为这是个好主意吗?请解释。

### 练习 6

如果一个 CUDA 设备的 SM 最多可以容纳 1536 个线程和最多 4 个线程块,以下哪种块配置会在 SM 中产生最多的线程数?

**选项:**

- **a. 每个块 128 个线程**
- **b. 每个块 256 个线程**
- **c. 每个块 512 个线程**
- **d. 每个块 1024 个线程**

### 练习 7

假设一个设备允许每个 SM 最多 64 个块和每个 SM 2048 个线程。指出以下哪些每个 SM 的分配是可能的。在可能的情况下,指出占用率水平。

**a. 8 个块,每个块 128 个线程**

**b. 16 个块,每个块 64 个线程**

**c. 32 个块,每个块 32 个线程**

**d. 64 个块,每个块 32 个线程**

**e. 32 个块,每个块 64 个线程**

### 练习 8

考虑一个具有以下硬件限制的 GPU:每个 SM 2048 个线程、每个 SM 32 个块、每个 SM 64K(65,536)个寄存器。对于以下每种内核特性,指出该内核是否可以达到完全占用。如果不能,指出限制因素。

**a. 内核使用每个块 128 个线程,每个线程 30 个寄存器。**

**b. 内核使用每个块 32 个线程,每个线程 29 个寄存器。**

**c. 内核使用每个块 256 个线程,每个线程 34 个寄存器。**

### 练习 9

一位学生提到他们能够使用 32 × 32 线程块的矩阵乘法内核来乘两个 1024 × 1024 矩阵。该学生使用的 CUDA 设备允许每个块最多 512 个线程,每个 SM 最多 8 个块。该学生进一步提到线程块中的每个线程计算结果矩阵的一个元素。你的反应是什么?为什么?
